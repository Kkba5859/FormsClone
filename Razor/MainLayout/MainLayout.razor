@using FormsClone.CSharp.UserManagement.Interfaces
@inherits LayoutComponentBase
@inject NavigationManager NavigationManager
@inject IUserService UserService

@namespace FormsClone.Razor.MainLayout

<div class="top-row ps-3 navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container-fluid">
        <a class="navbar-brand" href="/">FormsClone</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav me-auto">
                @if (IsLoggedIn) // Показываем меню "Forms", "Templates" и "Questions" для авторизованных пользователей
                {
                    <li class="nav-item">
                        <NavLink class="nav-link" href="/forms">
                            <span class="bi bi-file-earmark-text"></span> Forms
                        </NavLink>
                    </li>
                    <li class="nav-item">
                        <NavLink class="nav-link" href="/templates">
                            <span class="bi bi-file-earmark-text"></span> Templates
                        </NavLink>
                    </li>
                    <li class="nav-item">
                        <NavLink class="nav-link" href="/questions">
                            <span class="bi bi-question-circle"></span> Questions
                        </NavLink>
                    </li>
                }
            </ul>

            <ul class="navbar-nav ms-auto d-flex align-items-center">
                @if (IsLoggedIn) // Если пользователь авторизован
                {
                    <li class="nav-item me-3">
                        <span class="navbar-text text-light">Привет, @UserName</span>
                    </li>

                    @if (IsAdmin) // Кнопка "Dashboard" для администраторов
                    {
                        <li class="nav-item">
                            <NavLink class="nav-link" href="/admin-dashboard">
                                <span class="bi bi-speedometer2"></span> Dashboard
                            </NavLink>
                        </li>
                    }

                    <li class="nav-item">
                        <button class="btn btn-danger nav-link" @onclick="Logout">
                            <span class="bi bi-box-arrow-right"></span> Logout
                        </button>
                    </li>
                }
                else // Если пользователь не авторизован
                {
                    <li class="nav-item">
                        <NavLink class="nav-link" href="/login">
                            <span class="bi bi-box-arrow-in-right"></span> Login
                        </NavLink>
                    </li>
                    <li class="nav-item">
                        <NavLink class="nav-link" href="/register">
                            <span class="bi bi-person-plus-fill"></span> Sign Up
                        </NavLink>
                    </li>
                }
            </ul>
        </div>
    </div>
</div>

<div class="content px-4">
    @Body
</div>

@code {
    protected bool IsLoggedIn; // Состояние для проверки, залогинен ли пользователь
    protected bool IsAdmin; // Состояние для проверки, является ли пользователь администратором
    protected string UserName = string.Empty; // Имя текущего пользователя

    protected override async Task OnInitializedAsync()
    {
        await UpdateUserStatusAsync(); // Обновляем статус пользователя при инициализации
    }

    private async Task UpdateUserStatusAsync()
    {
        IsLoggedIn = await UserService.IsUserLoggedInAsync(); // Проверяем, авторизован ли пользователь

        if (IsLoggedIn)
        {
            IsAdmin = await UserService.IsUserAdminAsync(); // Проверяем, является ли пользователь администратором
            UserName = await UserService.GetUserNameAsync(); // Получаем имя пользователя
        }
        else
        {
            IsAdmin = false; // Сбрасываем статус администратора
            UserName = string.Empty; // Очищаем имя, если пользователь не авторизован
        }

        StateHasChanged(); // Обновляем состояние для правильного отображения элементов
    }

    private async Task Logout()
    {
        await UserService.LogoutUserAsync(); // Логаут пользователя
        await UpdateUserStatusAsync(); // Обновляем статус после выхода
        NavigationManager.NavigateTo("/"); // Перенаправляем на главную страницу
    }
}
