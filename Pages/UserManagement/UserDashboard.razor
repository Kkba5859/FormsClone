@page "/user-dashboard"
@using Blazored.LocalStorage
@using FormsClone.CSharp.UserManagement.AdminDashboard.Services
@using FormsClone.CSharp.UserManagement.Interfaces
@using FormsClone.CSharp.UserManagement.AdminDashboard.Models
@using System.Net.Http.Json;
@inject IUserService UserService
@inject NavigationManager NavigationManager
@inject ILoginService LoginService
@inject ILocalStorageService LocalStorageService
@inject IJSRuntime JS
@inject ISalesforceService SalesforceService
@inject IJiraService JiraService
@inject HttpClient HttpClient
@inject HttpClient Http


<h3 class="text-center mb-4">Личный кабинет</h3>

@if (_isLoading)
{
    <div class="text-center">
        <p class="text-info">Загрузка данных...</p>
    </div>
}
else if (_currentUser != null)
{
    <div class="table-responsive">
        <table class="table table-striped">
            <tr>
                <th>Имя пользователя:</th>
                <td>
                    <span class="badge bg-secondary">@(_currentUser.Username)</span>
                </td>
            </tr>
            <tr>
                <th>Администратор:</th>
                <td>
                    <span class="badge @(_currentUser.IsAdmin ? "bg-success" : "bg-secondary")">
                        @(_currentUser.IsAdmin ? "Да" : "Нет")
                    </span>
                </td>
            </tr>
            <tr>
                <th>Заблокирован:</th>
                <td>
                    <span class="badge @(_currentUser.IsBlocked ? "bg-danger" : "bg-primary")">
                        @(_currentUser.IsBlocked ? "Да" : "Нет")
                    </span>
                </td>
            </tr>
        </table>

        <div class="mt-4">
            <button class="btn btn-warning" @onclick="ShowChangePasswordModal">
                Сменить пароль
            </button>
            <button class="btn btn-danger" @onclick="DeleteAccount">
                Удалить аккаунт
            </button>
            <button class="btn btn-info" @onclick="FetchSalesforceData">Загрузить данные Salesforce</button>
            <button class="btn btn-primary" @onclick="CreateJiraIssue">Создать задачу в Jira</button>
        </div>
    </div>
}
else
{
    <div class="alert alert-danger text-center" role="alert">
        Вы не авторизованы. Пожалуйста, войдите в систему, чтобы получить доступ к своему кабинету.
    </div>
}

@if (_showModal)
{
    <div class="modal fade show d-block" style="background-color: rgba(0, 0, 0, 0.5);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Сменить пароль</h5>
                    <button type="button" class="btn-close" @onclick="Close"></button>
                </div>
                <div class="modal-body">
                    @if (!string.IsNullOrEmpty(_errorMessage))
                    {
                        <div class="alert alert-danger">@_errorMessage</div>
                    }
                    <div class="mb-3">
                        <label for="currentPassword">Текущий пароль</label>
                        <input type="password" id="currentPassword" class="form-control" @bind="_currentPassword" />
                    </div>
                    <div class="mb-3">
                        <label for="newPassword">Новый пароль</label>
                        <input type="password" id="newPassword" class="form-control" @bind="_newPassword" />
                    </div>
                    <div class="mb-3">
                        <label for="confirmNewPassword">Подтвердите новый пароль</label>
                        <input type="password" id="confirmNewPassword" class="form-control" @bind="_confirmNewPassword" />
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" @onclick="Close">Отмена</button>
                    <button class="btn btn-primary" @onclick="ChangePassword">Сохранить</button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private UserModel _currentUser;
    private bool _isLoading = true;
    private bool _showModal = false;
    private string _currentPassword;
    private string _newPassword;
    private string _confirmNewPassword;
    private string _errorMessage;

    protected override async Task OnInitializedAsync()
    {
        _currentUser = await LocalStorageService.GetItemAsync<UserModel>("currentUser");

        if (_currentUser == null)
        {
            NavigationManager.NavigateTo("/login");
            return;
        }

        _isLoading = false;

        // Дополнительная проверка для авторизации
        var isLoggedIn = await LoginService.IsUserLoggedInAsync();
        if (!isLoggedIn)
        {
            NavigationManager.NavigateTo("/login");
            return;
        }
    }
    private async Task CreateJiraIssue()
    {
        var issueData = new
        {
            projectKey = "SCRUM",
            summary = "Задача от пользователя",
            description = "Описание задачи, созданной из личного кабинета",
            issueType = "Task"
        };

        var response = await HttpClient.PostAsJsonAsync("https://localhost:5001/api/Jira/CreateIssue", issueData); // Замените Http на HttpClient
        if (response.IsSuccessStatusCode)
        {
            Console.WriteLine("Задача успешно создана.");
        }
        else
        {
            Console.WriteLine("Ошибка создания задачи.");
        }
    }

    private void ShowChangePasswordModal()
    {
        _currentPassword = string.Empty;
        _newPassword = string.Empty;
        _confirmNewPassword = string.Empty;
        _errorMessage = string.Empty;
        _showModal = true;
    }

    private void Close()
    {
        _showModal = false;
    }

    private async Task ChangePassword()
    {
        if (_newPassword != _confirmNewPassword)
        {
            _errorMessage = "Новый пароль и его подтверждение не совпадают.";
            return;
        }

        await UserService.ChangePasswordAsync(_currentUser.Username, _newPassword);
        await LocalStorageService.SetItemAsync("currentUser", _currentUser);
        Close();
    }

    private async Task DeleteAccount()
    {
        var confirmDelete = await JS.InvokeAsync<bool>("confirm", "Вы уверены, что хотите удалить свой аккаунт?");
        if (confirmDelete)
        {
            await UserService.DeleteUserAsync(_currentUser.Username);
            await LocalStorageService.RemoveItemAsync("currentUser");
            NavigationManager.NavigateTo("/login");
        }
    }

    private async Task FetchSalesforceData()
    {
        // Для получения токена доступа запрашиваем у пользователя имя пользователя и пароль
        string username = _currentUser.Username; // Если ваш пользователь уже аутентифицирован
        string password = "Kkba5859368a"; // Здесь нужно ввести пароль или его получать по-другому, например, из модального окна

        string accessToken = await SalesforceService.GetAccessToken(username, password);

        // Пример запроса к Salesforce
        string query = "SELECT Id, Name FROM Account LIMIT 10"; // Ваш SOQL запрос
        var salesforceData = await SalesforceService.GetSalesforceDataAsync(accessToken, query);
        // Здесь обрабатываем полученные данные, например, отображаем их на странице
    }
}
